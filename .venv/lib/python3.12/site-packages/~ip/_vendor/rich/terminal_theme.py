import streamlit as st
import pdfplumber
import re
import unicodedata

st.set_page_config(page_title="RH ‚Üí JSON (Dedica√ß√£o)", layout="wide")
st.title("Rela√ß√£o de Recursos Humanos ‚Üí JSON (com Dedica√ß√£o)")

# ---------------- Utils ----------------
def norm(s: str) -> str:
    s = unicodedata.normalize("NFD", s)
    s = "".join(ch for ch in s if unicodedata.category(ch) != "Mn")
    return s.casefold().strip()

def is_region_start(line: str) -> bool:
    return "relacao de recursos humanos" in norm(line)

def is_region_end(line: str) -> bool:
    """
    Fim da regi√£o: linha de resumo 'TOTAL ...' (n√£o confundir com 'Total Horas (Anual) ...').
    Para fechar, exigimos que a linha tenha 'total' e tamb√©m refer√™ncia a 'valor'.
    """
    n = norm(line)
    return n.startswith("total") and "valor" in n

def extract_region(pdf, start_page: int):
    """
    Retorna:
      region_text (str), start_info (p, ln, line), end_info (p, ln, line), lines_captured (int)
    """
    lines, extracting = [], False
    start_info, end_info = None, None
    for p in range(start_page - 1, len(pdf.pages)):
        text = pdf.pages[p].extract_text() or ""
        page_lines = text.splitlines()
        for li, raw in enumerate(page_lines, start=1):
            s = raw.strip()
            if not extracting and is_region_start(s):
                extracting = True
                start_info = (p + 1, li, s)
                continue
            if extracting:
                if is_region_end(s):
                    end_info = (p + 1, li, s)
                    extracting = False
                    break
                lines.append(s)
        # Se j√° encerramos e coletamos algo, sai
        if not extracting and lines:
            break
    return "\n".join(lines), start_info, end_info, len(lines)

def first_word_after_dedicacao(block: str) -> str:
    """
    Pega a primeira palavra imediatamente ap√≥s 'Dedica√ß√£o' (mesma linha; se n√£o houver, pr√≥xima linha).
    Aceita apenas: 'Parcial', 'Exclusivo', 'Exclusiva', 'Excluvisa'.
    """
    allowed = {"parcial", "exclusivo", "exclusiva", "excluvisa"}
    expecting_next_line = False

    for line in block.splitlines():
        words = re.findall(r"[A-Za-z√Ä-√ø]+", line)
        norms = [norm(w) for w in words]

        if expecting_next_line:
            for w, n in zip(words, norms):
                if n in allowed:
                    return w.capitalize()
            expecting_next_line = False  # n√£o fica esperando indefinidamente

        for i, n in enumerate(norms):
            if n == "dedicacao":  # tolera acentos via norm()
                # tenta mesma linha
                for j in range(i + 1, len(words)):
                    if norms[j] in allowed:
                        return words[j].capitalize()
                # sen√£o, tenta pr√≥xima linha
                expecting_next_line = True
                break

    return ""  # n√£o encontrado ou n√£o permitido

def parse_items(raw_text: str):
    """
    Fatia por 'Item N' e extrai campos b√°sicos + Dedica√ß√£o.
    Retorna lista de dicts (JSON-serializ√°vel).
    """
    # Remove decora√ß√µes de asterisco comuns em PDFs (**CPF **)
    raw_text = re.sub(r"\*+", "", raw_text)
    items = []

    marks = list(re.finditer(r"(?mi)^\s*Item\s+(\d+)\b", raw_text))
    flags = re.IGNORECASE | re.DOTALL

    for i, m in enumerate(marks):
        num = int(m.group(1))
        start = m.start()
        end = marks[i + 1].start() if i + 1 < len(marks) else len(raw_text)
        block = raw_text[start:end]
        block_sp = re.sub(r"\s+", " ", block)

        # Campos b√°sicos
        cpf_m  = re.search(r"\bCPF\s*([\d\.\-]+)\b", block, flags)
        nome_m = re.search(r"\bNome\s*(.*?)\s*Titula√ß(?:√£o|ao)\b", block_sp, flags)
        tit_m  = re.search(r"\bTitula√ß(?:√£o|ao)\s*(.*?)\s*Total\s*Horas\s*\(Anual\)\b", block_sp, flags)
        hr_m   = re.search(r"\bTotal\s*Horas\s*\(Anual\)\s*(\d+)\b", block_sp, flags)

        # Dedica√ß√£o (regra pedida)
        dedic = first_word_after_dedicacao(block)

        # Valor (√∫ltimo R$ do bloco, evita 'Valor Hora')
        vals = re.findall(r"R\$\s*([\d\.,]+)", block)
        valor = None
        if vals:
            v = vals[-1]
            try:
                valor = float(v.replace(".", "").replace(",", "."))
            except Exception:
                valor = None

        items.append({
            "Item": num,
            "CPF": cpf_m.group(1) if cpf_m else "",
            "Nome": (nome_m.group(1).strip() if nome_m else ""),
            "Titula√ß√£o": (tit_m.group(1).strip() if tit_m else ""),
            "Total Horas (Anual)": (int(hr_m.group(1)) if hr_m else None),
            "Dedica√ß√£o": dedic,
            "Valor (R$)": valor,
        })
    return items

# --------------- UI ---------------
uploaded_file = st.file_uploader("Envie o PDF", type="pdf")
start_page = st.number_input("P√°gina inicial", min_value=1, step=1, value=58)

# Processa automaticamente ao enviar arquivo (sem depender de bot√£o)
if uploaded_file:
    with pdfplumber.open(uploaded_file) as pdf:
        region_text, start_info, end_info, n_lines = extract_region(pdf, start_page)

    # DEBUG: mostra onde come√ßou/terminou e estat√≠sticas
    st.subheader("üìã DEBUG da regi√£o")
    st.write({
        "start_info (p√°gina, linha, conte√∫do)": start_info or "n√£o encontrado",
        "end_info (p√°gina, linha, conte√∫do)": end_info or "n√£o encontrado",
        "linhas_capturadas": n_lines
    })

    st.subheader("üßæ Bloco extra√≠do (confira se h√° 'Item ...', 'Dedica√ß√£o ...', 'Valor (R$) ...')")
    st.text_area("Texto bruto da regi√£o", region_text or "(vazio)", height=220)

    resultados = parse_items(region_text) if region_text else []
    st.session_state["resultado_rh"] = resultados  # guarda na sess√£o

    st.subheader("üß© JSON (resultado por Item)")
    st.json(resultados)  # SEMPRE mostra; se vazio, exibe []

    st.subheader("üîé Resumo r√°pido (Item ‚Üí Dedica√ß√£o)")
    if resultados:
        for r in resultados:
            st.write(f"Item {r['Item']:>3}: **{r['Dedica√ß√£o'] or '‚Äî'}**")
    else:
        st.write("Nenhum item montado. Verifique o DEBUG acima e a p√°gina inicial.")

elif "resultado_rh" in st.session_state:
    st.subheader("üß© JSON atual em sess√£o (√∫ltimo processamento)")
    st.json(st.session_state["resultado_rh"])
else:
    st.info("Envie um PDF e informe a p√°gina inicial para processar.")